<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Desdi despachos version 2</title>

  <!-- Responsive mÃ³vil + safe areas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0f172a">

  <!-- PERFORMANCE HINTS: DNS + TCP + TLS warm-up -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
  <link rel="dns-prefetch" href="https://googleusercontent.com">
  <link rel="dns-prefetch" href="https://ssl.gstatic.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin>
  <link rel="preconnect" href="https://ssl.gstatic.com" crossorigin>

  <style>
    html,body { height: 100%; margin: 0; }
    body {
      display: flex; flex-direction: column;
      min-height: 100svh; background: #0b1220; color: #e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .appbar {
      background:#0f172a; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding-left: calc(env(safe-area-inset-left, 0px) + 12px);
      padding-right: calc(env(safe-area-inset-right, 0px) + 12px);
      box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }
    .appbar h1 { font-size:16px; margin:0; font-weight:700; letter-spacing:.2px; }
    .actions { display:flex; gap:6px; }
    .btn {
      border:1px solid #334155; background:#111827; color:#e5e7eb; padding:6px 10px; border-radius:10px;
      font-size:12px; line-height:1; cursor:pointer; display:flex; align-items:center; gap:4px;
    }
    .btn.secondary { background:transparent; border-color:#475569; color:#cbd5e1; }
    .btn:hover { background:#0b1220; }
    .btn:active { transform: translateY(1px); }

    .main { position:relative; flex:1; min-height:0; overflow:hidden; }
    .frame-wrap { position:absolute; inset:0; }
    iframe { width:100%; height:100%; border:0; background:#fff; -webkit-overflow-scrolling:touch; }

    .loader {
      position:absolute; inset:0; display:grid; place-items:center;
      background: radial-gradient(100% 100% at 0% 0%, rgba(4, 6, 17, 0.75), rgba(4,6,17,0.9) 70%), #040611;
      z-index:2; transition: opacity .25s ease;
    }
    .loader.hidden { opacity:0; pointer-events:none; }
    .loadcard { display:flex; align-items:center; gap:10px; background:rgba(15,23,42,.6); border:1px solid #1f2937;
      padding:12px 14px; border-radius:14px; backdrop-filter: blur(4px); box-shadow: 0 10px 30px rgba(0,0,0,.35);}
    .spinner { width:42px; height:42px; border-radius:50%; border:4px solid #1f2937; border-top-color:#3b82f6; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loadtext { font-size:14px; color:#cbd5e1; }
    .progress { margin-top:6px; height:3px; width:160px; background:#1f2937; border-radius:99px; overflow:hidden; }
    .bar { height:100%; width:0%; background:#3b82f6; transition: width .4s ease; }

    .help { position:absolute; left:50%; transform:translateX(-50%); bottom:12px; font-size:12px; color:#cbd5e1; text-align:center; opacity:.9; }
    .help a { color:#93c5fd; text-decoration:underline; }

    .camera-notice {
      position: absolute; top: 12px; right: 12px; background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 8px;
      font-size: 11px; color: #93c5fd; z-index: 10; backdrop-filter: blur(4px);
      display: none;
    }

    @media (max-width:380px){ .appbar h1{font-size:14px} .btn{font-size:11px; padding:6px 8px} .loadtext{font-size:13px} }
  </style>
</head>
<body>
  <header class="appbar">
    <h1>ðŸ“‹ Planilla RUTA 700</h1>
    <div class="actions">
      <button class="btn" id="btnReload">â†» Recargar</button>
      <button class="btn secondary" id="btnCamera">ðŸ“· CÃ¡mara</button>
      <a class="btn secondary" id="btnOpen" target="_blank" rel="noopener">â†— Abrir</a>
    </div>
  </header>

  <div class="camera-notice" id="cameraNotice">
    Permiso de cÃ¡mara solicitado. Acepta en el navegador.
  </div>

  <main class="main">
    <div class="frame-wrap" id="frameWrap">
      <!-- El iframe se crea dinÃ¡micamente -->
      <div id="loader" class="loader">
        <div class="loadcard">
          <div class="spinner"></div>
          <div>
            <div class="loadtext" id="loadText">Preparando la aplicaciÃ³nâ€¦</div>
            <div class="progress"><div class="bar" id="bar"></div></div>
          </div>
        </div>
        <div class="help">
          Si tarda demasiado o la cÃ¡mara no funciona, <a id="openLink2" href="#" target="_blank" rel="noopener">Ã¡brela en una pestaÃ±a nueva</a>.
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const APP_URL = "https://script.google.com/macros/s/AKfycbxXPbgMVZHrZt28gPRP2cxFMbJI1zxef0I3-215Si-qGuY9uCh6U4GVpxHWq1HqE25Fwg/exec";
      const frameWrap = document.getElementById('frameWrap');
      const loader = document.getElementById('loader');
      const loadText = document.getElementById('loadText');
      const bar = document.getElementById('bar');
      const btnReload = document.getElementById('btnReload');
      const btnOpen = document.getElementById('btnOpen');
      const btnCamera = document.getElementById('btnCamera');
      const openLink2 = document.getElementById('openLink2');
      const cameraNotice = document.getElementById('cameraNotice');

      btnOpen.href = APP_URL;
      openLink2.href = APP_URL;

      // Red lenta: sugerir abrir en pestaÃ±a
      try {
        if (navigator.connection && ['slow-2g','2g'].includes(navigator.connection.effectiveType)) {
          loadText.textContent = "ConexiÃ³n lenta detectada. Recomendado abrirla en una pestaÃ±a nueva.";
        }
      } catch (_) {}

      // Progreso simulado mientras calientan conexiones
      let p = 0; const tick = () => { p = Math.min(92, p + Math.random()*10 + 3); bar.style.width = p + '%'; };
      const prog = setInterval(tick, 450);

      let created = false;
      let currentIframe = null;
      
      function createIframe(forceReload=false){
        if (created && !forceReload) return;
        created = true;
        
        const iframe = document.createElement('iframe');
        iframe.title = "Planilla RUTA 700";
        iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
        
        // PERMISOS ACTUALIZADOS - CRÃTICO PARA CÃMARA
        iframe.setAttribute('allow', 'camera; microphone; geolocation; display-capture; web-share; clipboard-read; clipboard-write');
        
        // Sandbox con permisos ampliados para cÃ¡mara
        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-pointer-lock allow-orientation-lock allow-presentation');
        
        // Atributos adicionales para compatibilidad
        iframe.setAttribute('allowfullscreen', '');
        iframe.setAttribute('allowtransparency', 'true');
        iframe.setAttribute('webkitallowfullscreen', '');
        iframe.setAttribute('mozallowfullscreen', '');
        
        // Cache-buster para ciertos navegadores mÃ³viles
        const url = APP_URL + (APP_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
        iframe.src = url;

        // Manejo de carga
        iframe.addEventListener('load', function() {
          clearInterval(prog);
          bar.style.width = '100%';
          
          // Intentar solicitar permisos de cÃ¡mara despuÃ©s de cargar
          setTimeout(() => {
            try {
              // Notificar al usuario sobre permisos
              cameraNotice.style.display = 'block';
              setTimeout(() => {
                cameraNotice.style.display = 'none';
              }, 3000);
            } catch (e) {
              console.log('NotificaciÃ³n de cÃ¡mara:', e.message);
            }
          }, 500);
          
          setTimeout(() => {
            loader.classList.add('hidden');
          }, 150);
        });

        // Manejo de errores
        iframe.addEventListener('error', function(e) {
          console.error('Error cargando iframe:', e);
          loadText.textContent = "Error al cargar. Intenta recargar.";
        });

        frameWrap.appendChild(iframe);
        currentIframe = iframe;
        
        // Forzar permisos adicionales despuÃ©s de un momento
        setTimeout(() => {
          iframe.setAttribute('allow', 'camera *; microphone *; geolocation *');
        }, 1000);
      }

      // FunciÃ³n para abrir cÃ¡mara en nueva pestaÃ±a
      function openCameraInNewTab() {
        const cameraUrl = APP_URL + '?mode=camera&t=' + Date.now();
        const newWindow = window.open(cameraUrl, '_blank');
        
        if (newWindow) {
          cameraNotice.textContent = "Abriendo cÃ¡mara en nueva pestaÃ±a...";
          cameraNotice.style.display = 'block';
          setTimeout(() => {
            cameraNotice.style.display = 'none';
          }, 2000);
        }
      }

      // BotÃ³n de cÃ¡mara
      btnCamera.addEventListener('click', function() {
        cameraNotice.textContent = "Solicitando acceso a cÃ¡mara...";
        cameraNotice.style.display = 'block';
        
        // Primero intentar en el iframe actual
        setTimeout(() => {
          if (currentIframe && currentIframe.contentWindow) {
            try {
              // Enviar mensaje al iframe para activar cÃ¡mara
              currentIframe.contentWindow.postMessage('ACTIVATE_CAMERA', '*');
            } catch (e) {
              console.log('No se puede acceder al iframe:', e);
            }
          }
          
          // Si despuÃ©s de 2 segundos no responde, sugerir nueva pestaÃ±a
          setTimeout(() => {
            if (cameraNotice.style.display === 'block') {
              cameraNotice.textContent = "Usa el botÃ³n de cÃ¡mara dentro de la app o abre en nueva pestaÃ±a";
            }
          }, 2000);
        }, 100);
      });

      // Escuchar mensajes del iframe
      window.addEventListener('message', function(event) {
        if (event.data === 'CAMERA_PERMISSION_NEEDED') {
          cameraNotice.textContent = "Haz clic en permitir cuando el navegador lo solicite";
          cameraNotice.style.display = 'block';
          setTimeout(() => {
            cameraNotice.style.display = 'none';
          }, 3000);
        }
      });

      // Crear iframe tras el primer idle o pequeÃ±a espera
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => createIframe(), { timeout: 1200 });
      } else {
        setTimeout(() => createIframe(), 300);
      }

      // TambiÃ©n ante primera interacciÃ³n
      ['click','keydown','touchstart'].forEach(ev => {
        window.addEventListener(ev, () => createIframe(), { once: true, passive: true });
      });

      // Recargar: elimina y recrea
      btnReload.addEventListener('click', () => {
        loader.classList.remove('hidden');
        loadText.textContent = "Recargandoâ€¦";
        bar.style.width = '0%'; p = 0;
        
        if (currentIframe) {
          currentIframe.remove();
          currentIframe = null;
        }
        
        created = false;
        createIframe(true);
      });

      // Fallback si tarda demasiado
      setTimeout(() => {
        if (!loader.classList.contains('hidden')) {
          loadText.textContent = "Sigue cargandoâ€¦ Puedes abrirla en una pestaÃ±a para acelerar.";
        }
      }, 10000);

      // Limpiar notificaciÃ³n de cÃ¡mara al hacer clic
      cameraNotice.addEventListener('click', () => {
        cameraNotice.style.display = 'none';
      });

    })();
  </script>
</body>
</html>
